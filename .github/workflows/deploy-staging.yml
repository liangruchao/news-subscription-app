# ============================================================
# GitHub Actions - 部署到 Staging 环境
# 触发条件: 推送到 develop 分支
# ============================================================

name: 部署到 Staging

on:
  push:
    branches: [ develop ]
  workflow_dispatch:

jobs:
  # ============================================================
  # 构建和测试
  # ============================================================
  build-and-test:
    name: 构建和测试
    runs-on: ubuntu-latest

    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置 JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      - name: 后端单元测试
        run: |
          cd backend
          mvn test -DskipITs=true

      - name: 后端集成测试
        run: |
          cd backend
          mvn verify -DskipUnitTests=true
        env:
          SPRING_PROFILES_ACTIVE: test

      - name: 前端测试
        run: |
          cd frontend
          npm ci
          npm run test

  # ============================================================
  # 构建 Docker 镜像
  # ============================================================
  build-image:
    name: 构建 Docker 镜像
    runs-on: ubuntu-latest
    needs: build-and-test

    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置 Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: 构建 Docker 镜像
        run: |
          GIT_COMMIT=${{ github.sha }}
          docker build -t news-app:staging-${GIT_COMMIT} \
            --build-arg GIT_COMMIT=${GIT_COMMIT} \
            --build-arg ENVIRONMENT=staging \
            -f Dockerfile .

      - name: 保存镜像
        run: |
          docker save news-app:staging-${{ github.sha }} | gzip > /tmp/news-app-staging.tar.gz

      - name: 上传镜像制品
        uses: actions/upload-artifact@v4
        with:
          name: docker-image-staging
          path: /tmp/news-app-staging.tar.gz
          retention-days: 7

  # ============================================================
  # 部署到 Staging
  # ============================================================
  deploy:
    name: 部署到 Staging
    runs-on: ubuntu-latest
    needs: build-image
    environment:
      name: staging
      url: http://${{ secrets.STAGING_VPS_HOST }}

    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 下载镜像制品
        uses: actions/download-artifact@v4
        with:
          name: docker-image-staging
          path: /tmp

      - name: 上传到 Staging VPS
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.STAGING_VPS_HOST }}
          username: ${{ secrets.STAGING_VPS_USER }}
          key: ${{ secrets.STAGING_VPS_SSH_KEY }}
          source: "/tmp/news-app-staging.tar.gz,deploy/staging/docker-compose.yml,deploy/staging/.env"
          target: "/var/www/news-app-staging"
          strip_components: 0

      - name: 在 VPS 上部署
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.STAGING_VPS_HOST }}
          username: ${{ secrets.STAGING_VPS_USER }}
          key: ${{ secrets.STAGING_VPS_SSH_KEY }}
          script: |
            set -e
            cd /var/www/news-app-staging

            # 加载新镜像
            docker load < /tmp/news-app-staging.tar.gz

            # 更新 .env 中的 GIT_COMMIT
            sed -i "s/GIT_COMMIT=.*/GIT_COMMIT=${{ github.sha }}/" .env

            # 停止旧容器
            docker-compose down

            # 启动新容器
            docker-compose up -d

            # 等待健康检查
            echo "等待服务启动..."
            sleep 30

            # 检查服务状态
            docker-compose ps
            docker-compose logs --tail=20 backend

            # 清理旧镜像
            docker image prune -f

            # 删除上传的归档文件
            rm -f /tmp/news-app-staging.tar.gz

  # ============================================================
  # 健康检查
  # ============================================================
  health-check:
    name: 健康检查
    runs-on: ubuntu-latest
    needs: deploy

    steps:
      - name: 检查 HTTP 端点
        run: |
          for i in {1..30}; do
            if curl -f http://${{ secrets.STAGING_VPS_HOST }}/health; then
              echo "✓ 健康检查通过"
              exit 0
            fi
            echo "等待中... ($i/30)"
            sleep 2
          done
          echo "✗ 健康检查失败"
          exit 1

      - name: 检查 API 端点
        run: |
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://${{ secrets.STAGING_VPS_HOST }}/api/auth/current)
          if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "401" ]; then
            echo "✓ API 端点正常 (HTTP $HTTP_CODE)"
          else
            echo "✗ API 端点异常 (HTTP $HTTP_CODE)"
            exit 1
          fi

  # ============================================================
  # 通知
  # ============================================================
  notify:
    name: 发送通知
    runs-on: ubuntu-latest
    needs: [build-and-test, build-image, deploy, health-check]
    if: always()

    steps:
      - name: 发送 Slack 通知
        if: env.SLACK_WEBHOOK_URL != ''
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          STATUS="${{ job.status }}"
          if [ "$STATUS" = "success" ]; then
            EMOJI="✅"
            COLOR="good"
          else
            EMOJI="❌"
            COLOR="danger"
          fi

          curl -X POST $SLACK_WEBHOOK_URL \
            -H 'Content-Type: application/json' \
            -d "{
              \"attachments\": [{
                \"color\": \"${COLOR}\",
                \"title\": \"${EMOJI} Staging 环境部署${STATUS}\",
                \"fields\": [
                  {\"title\": \"分支\", \"value\": \"${{ github.ref }}\", \"short\": true},
                  {\"title\": \"提交\", \"value\": \"${{ github.sha }}\", \"short\": true},
                  {\"title\": \"作者\", \"value\": \"${{ github.actor }}\", \"short\": true},
                  {\"title\": \"环境\", \"value\": \"Staging\", \"short\": true}
                ],
                \"footer\": \"GitHub Actions\",
                \"ts\": ${{ github.event.head_commit.timestamp }}
              }]
            }"

      - name: 部署总结
        run: |
          echo ""
          echo "=================================================================="
          echo "  Staging 环境部署完成"
          echo "=================================================================="
          echo "  状态:     ${{ job.status }}"
          echo "  分支:     ${{ github.ref_name }}"
          echo "  提交:     ${{ github.sha }}"
          echo "  访问地址: http://${{ secrets.STAGING_VPS_HOST }}/"
          echo "=================================================================="
